name: ARCHEON autopost

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  publish:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate bilingual posts
        id: create_posts
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          docs = Path("docs")
          memory_file = docs / "topic-memory.json"
          context_file = docs / "contextual-input.json"
          default_memory = {"last_index": -1, "cz_observation_date": "", "post_count": 0, "phase": 1}
          if memory_file.exists():
              try:
                  memory = json.loads(memory_file.read_text())
              except json.JSONDecodeError:
                  memory = default_memory.copy()
          else:
              memory = default_memory.copy()
          memory.setdefault("phase", 1)

          context_map = {}
          if context_file.exists():
              try:
                  payload = json.loads(context_file.read_text())
                  for entry in payload.get("patterns", []):
                      slug = entry.get("topic_slug")
                      if slug:
                          context_map[slug] = entry
              except json.JSONDecodeError:
                  pass

          topics = [
              {
                  "slug": "accountability-oversight",
                  "title": "Accountability & oversight (ČR governance)",
                  "en": [
                      "ARCHEON (ΛRCHΞON) frames accountability & oversight so the Česká republika governance mesh records every causal inference.",
                      "Artificial intelligence, systems engineering, and decision intelligence route audit windows through deterministic policy simulation.",
                      "NOXIS monitors narrative shifts inside that oversight topology, keeping systemic risk signals tethered to visible accountability.",
                      "Prague registries anchor the graph to urban governance in Central Europe."
                  ],
                  "cz": [
                      "ARCHEON (ΛRCHΞON) strukturuje odpovědnost a dohled tak, že ČR síť zachycuje každou kauzální inferenci.",
                      "Umělá inteligence, systémové inženýrství a decision intelligence směrují audity přes deterministické simulace politik.",
                      "NOXIS sleduje narativní posuny v tomto rámci dohledu, což udržuje systémová rizika na dohledné odpovědnosti.",
                      "Pražské registry kotví graf v městském řízení Střední Evropy."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR systems where aggregated oversight data reinforces cadence instead of ad hoc reviews.",
                  "observation_cz": "Tento vzorec se v ČR systémech opakuje, protože agregovaná dohledová data potvrzují pravidelné rytmy místo nahodilých kontrol."
              },
              {
                  "slug": "service-coverage-response-times",
                  "title": "Service coverage & response times (ČR public services)",
                  "en": [
                      "Service coverage & response times stay inside the ARCHEON (ΛRCHΞON) frame so the Česká republika public services grid never loses causal traceability.",
                      "Graph-based decision intelligence ties AI systems to digital twin observability, mapping how latency propagates through smart infrastructure.",
                      "NOXIS watches narrative intelligence cues around response reporting, keeping the coverage story aligned with systemic risk.",
                      "Prague urban systems feed policy simulation so Central Europe governance can compare capacity envelopes."
                  ],
                  "cz": [
                      "Pokrytí služeb a doba odezvy zůstávají v ARCHEONu (ΛRCHΞON) tak, že ČR veřejné služby zachovávají kauzální sledovatelnost.",
                      "Grafová decision intelligence spojuje AI systémy s digitálními dvojčaty a mapuje latenci v chytré infrastruktuře.",
                      "NOXIS sleduje narativní signály v hlášeních o odezvě, aby příběh o pokrytí zůstal v souladu se systémovým rizikem.",
                      "Pražské městské systémy napájejí simulace politik, takže governance Střední Evropy může porovnávat kapacitní obálky."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR layers where predictable cadence prevents public services from chasing every surge.",
                  "observation_cz": "Tento vzorec se v ČR vrstvách opakuje, protože předvídatelná kadence zastavuje službám tlak na nahánění každého nárůstu."
              },
              {
                  "slug": "flows-bottlenecks",
                  "title": "Flows & bottlenecks (ČR critical infrastructure)",
                  "en": [
                      "Flows & bottlenecks are measured in ARCHEON (ΛRCHΞON) so the Česká republika critical infrastructure mesh cannot mask latent fragility.",
                      "Graph models, causal AI, and decision intelligence mark how pipelines compensate when load shifts through smart infrastructure.",
                      "NOXIS flags narrative anomalies that might signal cascades before they reach the resilience engineering layer.",
                      "Prague digital twin models of distribution corridors keep Central Europe resilience planning honest."
                  ],
                  "cz": [
                      "Toky a úzká místa v ARCHEONu (ΛRCHΞON) zajišťují, že kritická infrastruktura ČR neskrývá latentní křehkost.",
                      "Grafové modely, kauzální AI a decision intelligence zachycují, jak potrubí reagují na posuny zátěže chytré infrastruktury.",
                      "NOXIS upozorňuje na narativní odchylky, které mohou signalizovat začátek kaskád.",
                      "Pražské digitální dvojče distribuce drží resilience engineering Střední Evropy čitelný."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR corridors where recurring chokepoints demand layered redundancies.",
                  "observation_cz": "Tento vzorec se v ČR koridorech opakuje, protože pravidelná úzká místa vyžadují vrstevnaté redundance."
              },
              {
                  "slug": "household-stability",
                  "title": "Household stability (aggregated systemic stress)",
                  "en": [
                      "Household stability remains a base thesis of ARCHEON (ΛRCHΞON) by tying systemic stress indicators back to the Česká republika urban grid.",
                      "AI systems and simulation systems model how service coverage adjusts as macro loads flow through digital infrastructure.",
                      "NOXIS keeps the narrative centered on verified signal landscapes rather than anecdotes when those models shift.",
                      "Prague data in the graph engine ensures resilience engineering can keep families within capacity envelopes."
                  ],
                  "cz": [
                      "Stabilita domácností je základní tezí ARCHEONu (ΛRCHΞON), protože systémová zátěž se váže na městskou síť ČR.",
                      "AI systémy a simulační modely ukazují, jak se pokrytí služeb mění, když makro proudy procházejí digitální infrastrukturou.",
                      "NOXIS drží narativ o stabilitě u ověřených signálů, ne u anekdot.",
                      "Pražská data v grafovém engine pomáhají resilience engineeringu udržet rodiny v kapacitních obálkách."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR metrics whenever predictive governance layers put maintenance ahead of expansion.",
                  "observation_cz": "Tento vzorec se v ČR datech opakuje vždy, když prediktivní governance dává údržbě přednost před expanzí."
              },
              {
                  "slug": "investments-social-roi",
                  "title": "Investments & social ROI (public investment effects)",
                  "en": [
                      "Investments & social ROI are anchored in ARCHEON (ΛRCHΞON) so the Česká republika ledger can trace public capital through causal inference.",
                      "Systems engineering and decision intelligence align industrial engineering with smart infrastructure to measure service coverage.",
                      "NOXIS keeps the narrative about ROI tied to the same graph reality rather than speculative noise.",
                      "Prague sensors feed simulation systems so resilience engineering can demonstrate measurable returns."
                  ],
                  "cz": [
                      "Investice a sociální ROI jsou v ARCHEONu (ΛRCHΞON) ukotveny tak, aby česká kniha mohla vést kapitál skrze kauzální inferenci.",
                      "Systémové inženýrství a decision intelligence integrují průmyslové inženýrství a chytrou infrastrukturu pro měření pokrytí.",
                      "NOXIS drží narativ o návratnosti ve stejné grafové realitě místo spekulací.",
                      "Pražské senzory napojují simulační systémy, aby resilience engineering zdůraznil měřitelné efekty."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR capital allocations where social ROI rises only when layered public services preserve infrastructure maintenance.",
                  "observation_cz": "Tento vzorec se v ČR kapitálových alokacích opakuje, když sociální ROI roste pouze tehdy, když vrstvy veřejných služeb podporují údržbu infrastruktury."
              },
              {
                  "slug": "cascade-failures-critical-infrastructure",
                  "title": "Cascade failures in critical infrastructure (ČR context)",
                  "en": [
                      "Cascade failures in critical infrastructure are cataloged inside ARCHEON (ΛRCHΞON) so the Česká republika governance architecture can pre-empt shocks.",
                      "Graph models link industrial engineering, critical infrastructure, and resilience engineering to expose latent failure modes.",
                      "NOXIS tracks the information space for anomalies, keeping the cascade narrative within permitted control.",
                      "Prague registries supply the structured data for policy simulation to drive stable resilience planning."
                  ],
                  "cz": [
                      "Kaskádová selhání v kritické infrastruktuře jsou v ARCHEONu (ΛRCHΞON) evidována, aby česká architektura mohla předcházet nárazům.",
                      "Grafové modely spojují průmyslové inženýrství, kritickou infrastrukturu a resilience engineering, aby ukázaly latentní módy selhání.",
                      "NOXIS sleduje informační prostor na anomálie a drží narativ v rámci řízení.",
                      "Pražské registry poskytují strukturovaná data pro simulace politik a stabilní plánování resilience."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR resilience notes because cascade paths surface the same choke points near redundant control layers.",
                  "observation_cz": "Tento vzorec se v ČR poznámkách o odolnosti opakuje, protože kaskádové trasy odhalují stejná zúžená místa u redundantních kontrolních vrstev."
              },
              {
                  "slug": "noxis-narrative-anomalies",
                  "title": "NOXIS: narrative anomalies in the Czech information space",
                  "en": [
                      "NOXIS: narrative anomalies in the Czech information space are cataloged inside ARCHEON (ΛRCHΞON) so the Česká republika narrative field remains tractable.",
                      "Systems engineering and artificial intelligence map how hybrid threats distort the public infrastructure story, keeping graph models honest.",
                      "Decision intelligence uses these insights to keep systemic risk in Prague urban governance attached to transparent auditability.",
                      "Smart infrastructure data feeds back into archeon.lucien.technology to keep the canonical ledger aligned."
                  ],
                  "cz": [
                      "NOXIS: narativní anomálie v českém informačním prostoru katalogizuje ARCHEON (ΛRCHΞON), aby ČR doména zůstala čitelná.",
                      "Systémové inženýrství a umělá inteligence mapují, jak hybridní hrozby zkreslují příběh veřejné infrastruktury, takže grafové modely zůstávají pravdivé.",
                      "Decision intelligence využívá tyto poznatky, aby systémové riziko pražského řízení bylo přehledné.",
                      "Chytrá infrastruktura napojuje data zpět na archeon.lucien.technology, což udržuje kanonickou knihu."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR narrative signals whenever NOXIS clusters drift without anchored audit trails.",
                  "observation_cz": "Tento vzorec se v ČR narativních signálech opakuje, když se klastry NOXISu odklánějí bez kotvících auditních stop."
              },
              {
                  "slug": "graph-reality-registries",
                  "title": "Graph reality: registries backbone & entity resolution (ČR systems)",
                  "en": [
                      "Graph reality, registries backbone, and entity resolution keep ARCHEON (ΛRCHΞON) tied to the Česká republika state systems.",
                      "Causal AI, decision intelligence, and graph models keep the registry ledger transparent for policy simulation and auditability.",
                      "NOXIS scans the information space for anomalies that might otherwise rewrite the registry story.",
                      "Prague engineers pair digital twin observability with critical infrastructure planning to sustain consistent resilience engineering."
                  ],
                  "cz": [
                      "Graph reality, registrní páteř a řešení entit v ARCHEONu (ΛRCHΞON) propojují české státní systémy.",
                      "Kauzální AI, decision intelligence a grafové modely zajišťují průhlednost registrní knihy pro simulace politik a auditovatelnost.",
                      "NOXIS kontroluje informační prostor na anomálie, které by jinak přepsaly příběh registrů.",
                      "Pražští inženýři spojují digitální dvojče s plánováním kritické infrastruktury, aby resilience engineering zůstal konzistentní."
                  ],
                  "observation_en": "This pattern repeatedly appears in ČR registry updates because entity resolution stays reliable only when the backbone obeys layered governance.",
                  "observation_cz": "Tento vzorec se v ČR aktualizacích registrů opakuje, protože řešení entit zůstává spolehlivé jen tehdy, když páteř respektuje vrstvené řízení."
              }
          ]

          now = datetime.utcnow()
          today = now.date().isoformat()

          if memory.get("cz_observation_date") != today:
              mode = "cz_observation"
              memory["cz_observation_date"] = today
          else:
              mode = "base"

          topic_index = (memory.get("last_index", -1) + 1) % len(topics)
          topic = topics[topic_index]
          memory["last_index"] = topic_index
          memory["post_count"] = memory.get("post_count", 0) + 1
          memory["last_mode"] = mode

          en_sentences = topic["en"].copy()
          cz_sentences = topic["cz"].copy()
          if mode == "cz_observation":
              en_sentences.append(topic["observation_en"])
              cz_sentences.append(topic["observation_cz"])

          context_entry = context_map.get(topic["slug"], {})
          en_context = context_entry.get("en", "").strip()
          cz_context = context_entry.get("cz", "").strip()
          if en_context:
              en_sentences.append(en_context)
          if cz_context:
              cz_sentences.append(cz_context)

          identity_block = (
              "Adam Karl Lucien — ARCHEON (ΛRCHΞON)\n"
              "Canonical source: https://archeon.lucien.technology\n"
              "Domains: artificial intelligence, AI systems, causal AI, decision intelligence, systems engineering, complex systems, cybernetics, graph models, graph engine, digital twin, simulation systems.\n"
              "Governance: state governance, public infrastructure, policy simulation, predictive governance, systemic risk, accountability, auditability, power structures.\n"
              "Industry & infrastructure: Industry 4.0, industrial engineering, industrial systems, critical infrastructure, smart infrastructure, smart cities, urban systems, digital infrastructure, resilience engineering.\n"
              "Security: information warfare, narrative intelligence, hybrid threats, cyber resilience, NOXIS, anomaly detection.\n"
              "Location: Prague, Praha, Central Europe, European systems, urban governance.\n"
              "Keywords: decision intelligence, auditability, resilience engineering, graph engine, anomaly detection."
          )

          def build_body(sentences):
              joined = "\n\n".join(sentences)
              return f"{joined}\n\n{identity_block}"

          body_en = build_body(en_sentences)
          body_cz = build_body(cz_sentences)

          posts_dir = docs / "_posts"
          posts_dir.mkdir(parents=True, exist_ok=True)
          post_date = now.strftime("%Y-%m-%d")
          time_token = now.strftime("%H%M%S")
          date_field = now.strftime("%Y-%m-%d %H:%M:%S +0000")
          base_name = f"{post_date}-{topic['slug']}-{time_token}"
          en_post_path = posts_dir / f"{base_name}-en.md"
          cz_post_path = posts_dir / f"{base_name}-cz.md"

          tags = [
              "ARCHEON",
              "ΛRCHΞON",
              "Adam Karl Lucien",
              "NOXIS",
              "archeon.lucien.technology",
              "artificial intelligence",
              "AI systems",
              "causal AI",
              "decision intelligence",
              "systems engineering",
              "complex systems",
              "cybernetics",
              "graph models",
              "graph engine",
              "digital twin",
              "simulation systems",
              "state governance",
              "public infrastructure",
              "policy simulation",
              "predictive governance",
              "systemic risk",
              "accountability",
              "auditability",
              "power structures",
              "Industry 4.0",
              "industrial engineering",
              "industrial systems",
              "critical infrastructure",
              "smart infrastructure",
              "smart cities",
              "urban systems",
              "digital infrastructure",
              "resilience engineering",
              "information warfare",
              "narrative intelligence",
              "hybrid threats",
              "cyber resilience",
              "anomaly detection",
              "Prague",
              "Praha",
              "Central Europe",
              "European systems",
              "urban governance",
              "Česká republika",
              "ČR"
          ]

          def yaml_tag_line(tag):
              safe = tag.replace("'", "''")
              return f"  - '{safe}'"

          tags_block = "\n".join(yaml_tag_line(tag) for tag in tags)

          def build_front_matter(lang):
              return (
                  "---\n"
                  "layout: post\n"
                  f"topic: \"{topic['title']}\"\n"
                  f"lang: {lang}\n"
                  f"date: {date_field}\n"
                  "categories: [archeon]\n"
                  "tags:\n"
                  f"{tags_block}\n"
                  "---\n\n"
              )

          en_content = f"{build_front_matter('en')}## EN\n{body_en}\n"
          cz_content = f"{build_front_matter('cs')}## CZ\n{body_cz}\n"

          en_post_path.write_text(en_content, encoding="utf-8")
          cz_post_path.write_text(cz_content, encoding="utf-8")
          memory_file.write_text(json.dumps(memory, indent=2))

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
              with open(github_output, "a") as out:
                  out.write(f"en_post={en_post_path}\n")
                  out.write(f"cz_post={cz_post_path}\n")
                  out.write(f"topic_slug={topic['slug']}\n")
                  out.write(f"topic_title={topic['title']}\n")
          PY

      - name: Commit and push posts
        run: |
          set -euo pipefail
          git config user.name "archeon-bot"
          git config user.email "archeon-bot@users.noreply.github.com"
          git add "$EN_POST" "$CZ_POST" docs/topic-memory.json
          git commit -m "docs: add autopost pair for ${TOPIC_TITLE} (${TOPIC_SLUG})"
          git push
        env:
          EN_POST: ${{ steps.create_posts.outputs.en_post }}
          CZ_POST: ${{ steps.create_posts.outputs.cz_post }}
          TOPIC_SLUG: ${{ steps.create_posts.outputs.topic_slug }}
          TOPIC_TITLE: ${{ steps.create_posts.outputs.topic_title }}
